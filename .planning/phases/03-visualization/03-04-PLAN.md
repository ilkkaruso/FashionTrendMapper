---
phase: 03-visualization
plan: 04
type: execute
wave: 3
depends_on: ["03-02"]
files_modified:
  - app/components/TrendModal.tsx
  - lib/utils/related-trends.ts
autonomous: true

must_haves:
  truths:
    - "User can click bubble to open modal"
    - "Modal displays trend name, score, change %"
    - "Modal shows source breakdown (Google score)"
    - "Modal shows related trends (similar titles)"
    - "User can close modal via X button or ESC key"
    - "Modal traps focus for accessibility"
  artifacts:
    - path: "app/components/TrendModal.tsx"
      provides: "Native dialog modal for trend details"
      min_lines: 100
      exports: ["TrendModal"]
    - path: "lib/utils/related-trends.ts"
      provides: "Text similarity for related trends"
      min_lines: 40
      exports: ["findRelatedTrends"]
  key_links:
    - from: "app/components/TrendModal.tsx"
      to: "HTMLDialogElement"
      via: "useRef<HTMLDialogElement>"
      pattern: "HTMLDialogElement"
    - from: "app/components/TrendModal.tsx"
      to: "lib/utils/related-trends"
      via: "findRelatedTrends function"
      pattern: "findRelatedTrends\\("
---

<objective>
Build native dialog modal for displaying trend details.

Purpose: Show full trend information when user clicks a bubble. Implements MODAL-01 through MODAL-04 (click opens modal, description, source breakdown, related trends).

Output: Accessible TrendModal component using native dialog element.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/intel/summary.md
@.planning/phases/03-visualization/03-RESEARCH.md
@.planning/phases/03-visualization/03-01-SUMMARY.md
@.planning/phases/03-visualization/03-02-SUMMARY.md

# Trend data structure
@lib/fetchers/types.ts

# Existing globals.css for styling
@app/globals.css
</context>

<tasks>

<task type="auto">
  <name>Create related trends utility</name>
  <files>lib/utils/related-trends.ts</files>
  <action>
    Create text similarity function for related trends (per 03-RESEARCH.md open question resolution):

    ```typescript
    import type { TrendWithHistory } from '@/lib/fetchers/types';

    /**
     * Find related trends via text similarity
     *
     * Uses simple word overlap to find trends with similar titles.
     * Per research: start with simple similarity, enhance later.
     *
     * @param targetTrend - The trend to find relatives for
     * @param allTrends - All available trends
     * @param limit - Max number of related trends to return
     * @returns Array of related trends sorted by similarity
     */
    export function findRelatedTrends(
      targetTrend: TrendWithHistory,
      allTrends: TrendWithHistory[],
      limit: number = 3
    ): TrendWithHistory[] {
      // Tokenize title to words
      const tokenize = (text: string): Set<string> => {
        const words = text.toLowerCase()
          .replace(/[^a-z0-9\s]/g, '')
          .split(/\s+/)
          .filter(w => w.length > 2); // Ignore short words
        return new Set(words);
      };

      const targetWords = tokenize(targetTrend.title);

      // Calculate similarity scores
      const scored = allTrends
        .filter(t => t.title !== targetTrend.title) // Exclude self
        .map(trend => {
          const trendWords = tokenize(trend.title);

          // Count shared words
          let sharedCount = 0;
          for (const word of targetWords) {
            if (trendWords.has(word)) {
              sharedCount++;
            }
          }

          // Jaccard similarity: intersection / union
          const union = new Set([...targetWords, ...trendWords]);
          const similarity = sharedCount / union.size;

          return { trend, similarity };
        })
        .filter(item => item.similarity > 0) // Must have at least 1 shared word
        .sort((a, b) => b.similarity - a.similarity)
        .slice(0, limit);

      return scored.map(item => item.trend);
    }
    ```

    CRITICAL: Simple text similarity (shared words) per research recommendation.
  </action>
  <verify>
    TypeScript compiles lib/utils/related-trends.ts without errors.
    findRelatedTrends(['baggy jeans', 'skinny jeans', 'aesthetic']) finds 'skinny jeans' as related to 'baggy jeans'.
  </verify>
  <done>
    related-trends.ts exports findRelatedTrends function.
    Function calculates Jaccard similarity from shared words.
  </done>
</task>

<task type="auto">
  <name>Create TrendModal component</name>
  <files>app/components/TrendModal.tsx</files>
  <action>
    Create TrendModal using native dialog element (per 03-RESEARCH.md Pattern 3):

    ```typescript
    'use client';

    import { useRef, useEffect } from 'react';
    import type { TrendWithHistory } from '@/lib/fetchers/types';
    import { findRelatedTrends } from '@/lib/utils/related-trends';

    interface TrendModalProps {
      trend: TrendWithHistory | null;
      allTrends: TrendWithHistory[];
      isOpen: boolean;
      onClose: () => void;
    }

    export function TrendModal({ trend, allTrends, isOpen, onClose }: TrendModalProps) {
      const dialogRef = useRef<HTMLDialogElement>(null);

      // Handle dialog open/close
      useEffect(() => {
        const dialog = dialogRef.current;
        if (!dialog) return;

        if (isOpen) {
          dialog.showModal(); // Use showModal() for proper accessibility
        } else {
          dialog.close();
        }
      }, [isOpen]);

      // Close on ESC key (native dialog handles this, but also call onClose)
      useEffect(() => {
        const dialog = dialogRef.current;
        if (!dialog) return;

        const handleClose = () => {
          onClose();
        };

        dialog.addEventListener('close', handleClose);
        return () => {
          dialog.removeEventListener('close', handleClose);
        };
      }, [onClose]);

      if (!trend) return null;

      const relatedTrends = findRelatedTrends(trend, allTrends, 3);

      return (
        <dialog
          ref={dialogRef}
          className="rounded-lg p-0 shadow-xl backdrop:bg-black/50 max-w-lg w-full"
        >
          <div className="p-6 space-y-6">
            {/* Header */}
            <div className="flex justify-between items-start">
              <h2 className="text-2xl font-bold text-gray-900">
                {trend.title}
              </h2>
              <button
                onClick={onClose}
                aria-label="Close"
                className="text-gray-400 hover:text-gray-600 transition-colors"
              >
                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                </svg>
              </button>
            </div>

            {/* Popularity Score */}
            <div>
              <h3 className="text-sm font-semibold text-gray-500 uppercase mb-2">
                Popularity Score
              </h3>
              <div className="flex items-baseline gap-2">
                <span className="text-5xl font-bold text-gray-900">
                  {trend.score.toFixed(1)}
                </span>
                <span className="text-lg text-gray-500">/ 100</span>
              </div>
              <p className={`text-sm mt-1 ${trend.changePercent >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                {trend.changePercent > 0 ? '+' : ''}{trend.changePercent.toFixed(1)}% from yesterday
              </p>
            </div>

            {/* Source Breakdown */}
            <div>
              <h3 className="text-sm font-semibold text-gray-500 uppercase mb-2">
                Source Breakdown
              </h3>
              <div className="space-y-2">
                {trend.sourceBreakdown.map(sb => (
                  <div key={sb.source} className="flex justify-between items-center">
                    <span className="capitalize text-gray-700">{sb.source}</span>
                    <div className="flex items-center gap-2">
                      <div className="w-32 h-2 bg-gray-200 rounded-full overflow-hidden">
                        <div
                          className="h-full bg-blue-600 rounded-full"
                          style={{ width: `${sb.score}%` }}
                        />
                      </div>
                      <span className="text-sm font-medium text-gray-900 w-12 text-right">
                        {sb.score.toFixed(1)}
                      </span>
                    </div>
                  </div>
                ))}
              </div>
            </div>

            {/* Related Trends */}
            {relatedTrends.length > 0 && (
              <div>
                <h3 className="text-sm font-semibold text-gray-500 uppercase mb-2">
                  Related Trends
                </h3>
                <ul className="space-y-2">
                  {relatedTrends.map(related => (
                    <li
                      key={related.title}
                      className="flex justify-between items-center text-sm"
                    >
                      <span className="text-gray-700">{related.title}</span>
                      <span className="font-medium text-gray-900">
                        {related.score.toFixed(0)}
                      </span>
                    </li>
                  ))}
                </ul>
              </div>
            )}
          </div>
        </dialog>
      );
    }
    ```

    CRITICAL:
    - Use native <dialog> element with showModal() for accessibility
    - ESC key closes automatically (native behavior)
    - backdrop:bg-black/50 styles the backdrop (Tailwind v3+)
    - Focus trapping automatic with showModal()
    - Close button has aria-label for screen readers
  </action>
  <verify>
    TypeScript compiles app/components/TrendModal.tsx without errors.
    Component renders dialog element with trend details.
    Component imports findRelatedTrends.
  </verify>
  <done>
    TrendModal displays trend name, score, change %, sources, related trends.
    Modal uses native dialog element for accessibility.
    ESC key and X button both close modal.
    Related trends calculated via text similarity.
  </done>
</task>

</tasks>

<verification>
Run all verification commands:
- npm run build (TypeScript compilation succeeds)
- Check both files exist
- Verify TrendModal uses HTMLDialogElement
- Verify findRelatedTrends uses Jaccard similarity
</verification>

<success_criteria>
1. related-trends.ts finds similar trends via word overlap
2. TrendModal uses native dialog element
3. Modal displays: title, score, change %, source breakdown, related trends
4. Modal opens via showModal() for accessibility
5. ESC key closes modal (native behavior)
6. Close button has aria-label
7. Related trends limited to 3
8. All TypeScript compilation passes
9. Component marked 'use client'
</success_criteria>

<output>
After completion, create `.planning/phases/03-visualization/03-04-SUMMARY.md`
</output>
