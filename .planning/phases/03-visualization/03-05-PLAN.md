---
phase: 03-visualization
plan: 05
type: execute
wave: 4
depends_on: ["03-02", "03-03", "03-04"]
files_modified:
  - app/page.tsx
  - app/api/trends/route.ts
autonomous: true

must_haves:
  truths:
    - "Home page displays full visualization with bubbles"
    - "API endpoint serves trends from database"
    - "Bubbles render with correct data from API"
    - "Filters work and update visible bubbles"
    - "Clicking bubble opens modal with details"
    - "Page is responsive on mobile and desktop"
  artifacts:
    - path: "app/page.tsx"
      provides: "Main home page with full visualization"
      min_lines: 120
    - path: "app/api/trends/route.ts"
      provides: "API endpoint for trends with change data"
      exports: ["GET"]
  key_links:
    - from: "app/page.tsx"
      to: "app/components/BubbleChart"
      via: "BubbleChart component import"
      pattern: "import.*BubbleChart"
    - from: "app/page.tsx"
      to: "app/components/FilterBar"
      via: "FilterBar component import"
      pattern: "import.*FilterBar"
    - from: "app/page.tsx"
      to: "app/components/TrendModal"
      via: "TrendModal component import"
      pattern: "import.*TrendModal"
    - from: "app/page.tsx"
      to: "/api/trends"
      via: "fetch call"
      pattern: "fetch.*['\"].*trends['\"]"
    - from: "app/api/trends/route.ts"
      to: "lib/database/trend-repository"
      via: "getTrendsWithChange function"
      pattern: "getTrendsWithChange"
---

<objective>
Wire all components together on home page with API integration.

Purpose: Complete the visualization by integrating all components, fetching real trend data, and making the full experience functional. Final step of Phase 3.

Output: Working home page with animated bubbles, filters, and modal showing real data from database.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/intel/summary.md
@.planning/phases/03-visualization/03-RESEARCH.md
@.planning/phases/03-visualization/03-01-SUMMARY.md
@.planning/phases/03-visualization/03-02-SUMMARY.md
@.planning/phases/03-visualization/03-03-SUMMARY.md
@.planning/phases/03-visualization/03-04-SUMMARY.md

# Components to integrate
@app/components/BubbleChart.tsx
@app/components/FilterBar.tsx
@app/components/TrendModal.tsx

# Data layer
@lib/database/trend-repository.ts
@lib/fetchers/types.ts

# Hooks
@lib/hooks/useResizeObserver.ts
@lib/hooks/useTrendFiltering.ts

# Existing home page to replace
@app/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Create GET /api/trends endpoint</name>
  <files>app/api/trends/route.ts</files>
  <action>
    Create API endpoint serving trends with change data:

    ```typescript
    import { NextResponse } from 'next/server';
    import { getTrendsWithChange } from '@/lib/database/trend-repository';

    /**
     * GET /api/trends
     *
     * Returns all trends with popularity scores and daily change percentages.
     * Used by home page visualization.
     *
     * @returns JSON array of TrendWithHistory objects
     */
    export async function GET() {
      try {
        const trends = await getTrendsWithChange();

        return NextResponse.json({
          success: true,
          data: trends,
          lastUpdated: new Date().toISOString(),
        });
      } catch (error) {
        console.error('Error fetching trends:', error);

        return NextResponse.json(
          {
            success: false,
            error: 'Failed to fetch trends',
            data: [],
          },
          { status: 500 }
        );
      }
    }
    ```

    CRITICAL:
    - Use getTrendsWithChange from trend-repository (already sorts by score descending)
    - Return lastUpdated timestamp for FilterBar display
    - Handle errors gracefully (return empty array, not crash)
  </action>
  <verify>
    TypeScript compiles app/api/trends/route.ts without errors.
    curl http://localhost:3000/api/trends returns JSON with trends array.
  </verify>
  <done>
    /api/trends endpoint returns trends from database.
    Response includes success, data, lastUpdated fields.
    Errors return 500 with error message.
  </done>
</task>

<task type="auto">
  <name>Wire home page with all components</name>
  <files>app/page.tsx</files>
  <action>
    Replace existing home page with full visualization:

    ```typescript
    'use client';

    import { useEffect, useState } from 'react';
    import { BubbleChart } from './components/BubbleChart';
    import { FilterBar } from './components/FilterBar';
    import { TrendModal } from './components/TrendModal';
    import { useResizeObserver } from '@/lib/hooks/useResizeObserver';
    import { useTrendFiltering } from '@/lib/hooks/useTrendFiltering';
    import type { TrendWithHistory } from '@/lib/fetchers/types';

    interface TrendsResponse {
      success: boolean;
      data: TrendWithHistory[];
      lastUpdated: string;
      error?: string;
    }

    export default function Home() {
      const [trends, setTrends] = useState<TrendWithHistory[]>([]);
      const [lastUpdated, setLastUpdated] = useState<string>('');
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState<string | null>(null);

      // Modal state
      const [selectedTrend, setSelectedTrend] = useState<TrendWithHistory | null>(null);
      const [isModalOpen, setIsModalOpen] = useState(false);

      // Responsive sizing
      const { ref: containerRef, dimensions } = useResizeObserver<HTMLDivElement>();

      // Filtering
      const {
        filteredTrends,
        searchQuery,
        setSearchQuery,
        category,
        setCategory,
      } = useTrendFiltering(trends);

      // Fetch trends on mount
      useEffect(() => {
        async function fetchTrends() {
          try {
            setLoading(true);
            const response = await fetch('/api/trends');
            const json: TrendsResponse = await response.json();

            if (json.success) {
              setTrends(json.data);
              setLastUpdated(json.lastUpdated);
            } else {
              setError(json.error || 'Failed to load trends');
            }
          } catch (err) {
            console.error('Error fetching trends:', err);
            setError('Failed to load trends');
          } finally {
            setLoading(false);
          }
        }

        fetchTrends();
      }, []);

      // Handle bubble click
      const handleBubbleClick = (trend: TrendWithHistory) => {
        setSelectedTrend(trend);
        setIsModalOpen(true);
      };

      // Handle modal close
      const handleModalClose = () => {
        setIsModalOpen(false);
        setSelectedTrend(null);
      };

      return (
        <div className="flex flex-col h-screen">
          {/* Header */}
          <header className="bg-white border-b border-gray-200 px-6 py-4">
            <h1 className="text-2xl font-bold text-gray-900">
              Fashion Trend Mapper
            </h1>
            <p className="text-sm text-gray-600 mt-1">
              Discover trending fashion items and styles
            </p>
          </header>

          {/* Filter Bar */}
          <FilterBar
            searchQuery={searchQuery}
            onSearchChange={setSearchQuery}
            category={category}
            onCategoryChange={setCategory}
            lastUpdated={lastUpdated}
          />

          {/* Visualization Container */}
          <div ref={containerRef} className="flex-1 bg-gray-50">
            {loading && (
              <div className="flex items-center justify-center h-full">
                <div className="text-center">
                  <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
                  <p className="text-gray-600">Loading trends...</p>
                </div>
              </div>
            )}

            {error && (
              <div className="flex items-center justify-center h-full">
                <div className="text-center text-red-600">
                  <p className="font-semibold">Error loading trends</p>
                  <p className="text-sm mt-1">{error}</p>
                </div>
              </div>
            )}

            {!loading && !error && dimensions.width > 0 && dimensions.height > 0 && (
              <BubbleChart
                trends={filteredTrends}
                width={dimensions.width}
                height={dimensions.height}
                onBubbleClick={handleBubbleClick}
              />
            )}
          </div>

          {/* Trend Modal */}
          <TrendModal
            trend={selectedTrend}
            allTrends={trends}
            isOpen={isModalOpen}
            onClose={handleModalClose}
          />
        </div>
      );
    }
    ```

    CRITICAL:
    - Mark 'use client' (uses useState, useEffect, hooks)
    - useResizeObserver for responsive sizing
    - useTrendFiltering for filter state management
    - Loading and error states for UX
    - Full height layout (h-screen, flex-1) for visualization
    - Pass filteredTrends to BubbleChart (not all trends)
  </action>
  <verify>
    TypeScript compiles app/page.tsx without errors.
    npm run dev shows home page without errors.
    Page imports all 3 component modules.
  </verify>
  <done>
    Home page integrates BubbleChart, FilterBar, TrendModal.
    Page fetches trends from /api/trends on mount.
    Filters update visible bubbles.
    Clicking bubble opens modal.
    Page is responsive via useResizeObserver.
  </done>
</task>

</tasks>

<verification>
Run all verification commands:
- npm run build (TypeScript compilation succeeds)
- npm run dev (dev server starts)
- Visit http://localhost:3000 (page loads without errors)
- Check browser console for errors
- Test: type in search box (bubbles filter)
- Test: click category button (bubbles filter)
- Test: click bubble (modal opens)
- Test: press ESC or click X (modal closes)
- Test: resize browser window (bubbles reposition)
</verification>

<success_criteria>
1. /api/trends endpoint returns trends with change data
2. Home page fetches trends from API on mount
3. BubbleChart renders with animated bubbles
4. FilterBar displays search, categories, last updated
5. Search and category filters update visible bubbles
6. Clicking bubble opens TrendModal
7. Modal displays trend details, sources, related trends
8. ESC and X button close modal
9. Page responsive on mobile and desktop (ResizeObserver)
10. Loading and error states display correctly
11. All TypeScript compilation passes
12. Page marked 'use client'
</success_criteria>

<output>
After completion, create `.planning/phases/03-visualization/03-05-SUMMARY.md`

Mark Phase 3 as COMPLETE in ROADMAP.md.
</output>
