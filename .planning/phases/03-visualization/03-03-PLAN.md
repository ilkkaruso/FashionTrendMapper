---
phase: 03-visualization
plan: 03
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - app/components/FilterBar.tsx
  - lib/hooks/useTrendFiltering.ts
  - lib/utils/category-matcher.ts
autonomous: true

must_haves:
  truths:
    - "User can type in search box to filter trends by name"
    - "User can click category buttons to filter by category"
    - "Search and category filters work together (AND logic)"
    - "Filter state persists in URL (shareable links)"
    - "Last updated timestamp displays on page"
  artifacts:
    - path: "app/components/FilterBar.tsx"
      provides: "Search input, category buttons, last updated timestamp"
      min_lines: 80
      exports: ["FilterBar"]
    - path: "lib/hooks/useTrendFiltering.ts"
      provides: "Filter logic with URL state management"
      min_lines: 60
      exports: ["useTrendFiltering"]
    - path: "lib/utils/category-matcher.ts"
      provides: "Keyword-based category detection"
      min_lines: 40
      exports: ["detectCategory", "CATEGORIES"]
  key_links:
    - from: "app/components/FilterBar.tsx"
      to: "next/navigation"
      via: "useSearchParams for URL state"
      pattern: "useSearchParams"
    - from: "lib/hooks/useTrendFiltering.ts"
      to: "lib/utils/category-matcher"
      via: "detectCategory function"
      pattern: "detectCategory\\("
---

<objective>
Build search and category filtering with URL state management.

Purpose: Enable users to filter visible trends by search query and category. Implements DATA-01 through DATA-04 (category filtering, search, last updated, sorting).

Output: Working FilterBar component and filtering hook that update URL and filter trends.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/intel/summary.md
@.planning/phases/03-visualization/03-RESEARCH.md
@.planning/phases/03-visualization/03-01-SUMMARY.md

# Trend data structure
@lib/fetchers/types.ts

# Existing globals.css for styling
@app/globals.css
</context>

<tasks>

<task type="auto">
  <name>Create category matcher utility</name>
  <files>lib/utils/category-matcher.ts</files>
  <action>
    Create keyword-based category detection (per 03-RESEARCH.md open question resolution):

    ```typescript
    /**
     * Category detection via keyword matching
     *
     * Maps trend titles to categories based on keywords.
     * Used for filtering since database doesn't store categories.
     */

    export const CATEGORIES = [
      'all',
      'clothing',
      'styles',
      'brands',
      'colors',
      'accessories',
    ] as const;

    export type Category = typeof CATEGORIES[number];

    const CATEGORY_KEYWORDS: Record<Exclude<Category, 'all'>, string[]> = {
      clothing: [
        'jeans', 'dress', 'shirt', 'pants', 'jacket', 'coat', 'sweater',
        'hoodie', 'skirt', 'shorts', 'blazer', 'suit', 'top', 'blouse',
      ],
      styles: [
        'aesthetic', 'style', 'core', 'vibe', 'look', 'outfit', 'fashion',
        'trend', 'vintage', 'retro', 'modern', 'classic', 'casual', 'formal',
      ],
      brands: [
        'nike', 'adidas', 'zara', 'h&m', 'gucci', 'prada', 'chanel', 'dior',
        'balenciaga', 'supreme', 'uniqlo', 'gap', 'levi', 'calvin', 'tommy',
      ],
      colors: [
        'black', 'white', 'red', 'blue', 'green', 'yellow', 'pink', 'purple',
        'orange', 'brown', 'gray', 'beige', 'navy', 'olive', 'burgundy',
      ],
      accessories: [
        'bag', 'shoe', 'belt', 'hat', 'scarf', 'jewelry', 'watch', 'glasses',
        'sunglasses', 'necklace', 'bracelet', 'earring', 'ring', 'purse',
      ],
    };

    /**
     * Detect category from trend title via keyword matching
     *
     * @param title - Trend title to categorize
     * @returns First matching category or 'styles' as default
     */
    export function detectCategory(title: string): Exclude<Category, 'all'> {
      const lowerTitle = title.toLowerCase();

      for (const [category, keywords] of Object.entries(CATEGORY_KEYWORDS)) {
        if (keywords.some(keyword => lowerTitle.includes(keyword))) {
          return category as Exclude<Category, 'all'>;
        }
      }

      // Default to 'styles' if no match
      return 'styles';
    }
    ```

    CRITICAL: Categories detected via keywords (no DB schema change needed per research).
  </action>
  <verify>
    TypeScript compiles lib/utils/category-matcher.ts without errors.
    detectCategory('baggy jeans') returns 'clothing'.
    detectCategory('aesthetic') returns 'styles'.
  </verify>
  <done>
    category-matcher.ts exports CATEGORIES array and detectCategory function.
    Keyword lists cover major fashion categories.
  </done>
</task>

<task type="auto">
  <name>Create useTrendFiltering hook</name>
  <files>lib/hooks/useTrendFiltering.ts</files>
  <action>
    Create filtering hook with URL state management (per 03-RESEARCH.md Pattern 5):

    ```typescript
    'use client';

    import { useSearchParams, useRouter } from 'next/navigation';
    import { useMemo } from 'react';
    import type { TrendWithHistory } from '@/lib/fetchers/types';
    import { detectCategory, type Category } from '@/lib/utils/category-matcher';

    export function useTrendFiltering(allTrends: TrendWithHistory[]) {
      const searchParams = useSearchParams();
      const router = useRouter();

      const searchQuery = searchParams.get('search') || '';
      const category = (searchParams.get('category') || 'all') as Category;

      const setSearchQuery = (query: string) => {
        const params = new URLSearchParams(searchParams);
        if (query) {
          params.set('search', query);
        } else {
          params.delete('search');
        }
        router.push(`?${params.toString()}`);
      };

      const setCategory = (cat: Category) => {
        const params = new URLSearchParams(searchParams);
        if (cat && cat !== 'all') {
          params.set('category', cat);
        } else {
          params.delete('category');
        }
        router.push(`?${params.toString()}`);
      };

      // Filter trends
      const filteredTrends = useMemo(() => {
        return allTrends.filter(trend => {
          // Search filter
          if (searchQuery && !trend.title.toLowerCase().includes(searchQuery.toLowerCase())) {
            return false;
          }

          // Category filter
          if (category !== 'all') {
            const trendCategory = detectCategory(trend.title);
            if (trendCategory !== category) {
              return false;
            }
          }

          return true;
        });
      }, [allTrends, searchQuery, category]);

      return {
        filteredTrends,
        searchQuery,
        setSearchQuery,
        category,
        setCategory,
      };
    }
    ```

    CRITICAL:
    - Use Next.js useSearchParams and useRouter for URL state
    - Filters apply AND logic (both search and category must match)
    - useMemo prevents re-filtering on every render
  </action>
  <verify>
    TypeScript compiles lib/hooks/useTrendFiltering.ts without errors.
    Hook returns filteredTrends, search/category state, and setters.
  </verify>
  <done>
    useTrendFiltering hook manages filter state in URL.
    Hook filters trends by search query and category.
    Filter changes update URL (shareable links).
  </done>
</task>

<task type="auto">
  <name>Create FilterBar component</name>
  <files>app/components/FilterBar.tsx</files>
  <action>
    Create FilterBar with search, category buttons, and last updated timestamp:

    ```typescript
    'use client';

    import { CATEGORIES, type Category } from '@/lib/utils/category-matcher';

    interface FilterBarProps {
      searchQuery: string;
      onSearchChange: (query: string) => void;
      category: Category;
      onCategoryChange: (category: Category) => void;
      lastUpdated?: string; // ISO date string
    }

    export function FilterBar({
      searchQuery,
      onSearchChange,
      category,
      onCategoryChange,
      lastUpdated,
    }: FilterBarProps) {
      return (
        <div className="w-full bg-white border-b border-gray-200 p-4 space-y-4">
          {/* Search input */}
          <div className="max-w-md">
            <label htmlFor="search" className="sr-only">Search trends</label>
            <input
              id="search"
              type="text"
              value={searchQuery}
              onChange={(e) => onSearchChange(e.target.value)}
              placeholder="Search trends..."
              className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            />
          </div>

          {/* Category filters */}
          <div className="flex flex-wrap gap-2">
            {CATEGORIES.map(cat => (
              <button
                key={cat}
                onClick={() => onCategoryChange(cat)}
                className={`
                  px-4 py-2 rounded-full text-sm font-medium transition-colors
                  ${category === cat
                    ? 'bg-blue-600 text-white'
                    : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                  }
                `}
              >
                {cat.charAt(0).toUpperCase() + cat.slice(1)}
              </button>
            ))}
          </div>

          {/* Last updated timestamp */}
          {lastUpdated && (
            <div className="text-sm text-gray-500">
              Last updated: {new Date(lastUpdated).toLocaleString('en-US', {
                month: 'short',
                day: 'numeric',
                hour: 'numeric',
                minute: '2-digit',
              })}
            </div>
          )}
        </div>
      );
    }
    ```

    CRITICAL:
    - Accessible: label for search input, button semantics
    - Visual feedback: active category has blue background
    - Responsive: flex-wrap for category buttons on mobile
    - Last updated shows human-readable date
  </action>
  <verify>
    TypeScript compiles app/components/FilterBar.tsx without errors.
    Component renders search input, category buttons, timestamp.
  </verify>
  <done>
    FilterBar component displays search, categories, last updated.
    Active category has visual indicator.
    Component uses Tailwind classes for styling.
  </done>
</task>

</tasks>

<verification>
Run all verification commands:
- npm run build (TypeScript compilation succeeds)
- Check all 3 files exist
- Verify useTrendFiltering imports useSearchParams
- Verify FilterBar imports CATEGORIES
</verification>

<success_criteria>
1. category-matcher.ts detects categories via keywords
2. useTrendFiltering hook manages search and category filters
3. useTrendFiltering updates URL params (shareable links)
4. FilterBar component renders search input and category buttons
5. FilterBar displays last updated timestamp
6. Active category button has visual indicator
7. All TypeScript compilation passes
8. Components marked 'use client'
</success_criteria>

<output>
After completion, create `.planning/phases/03-visualization/03-03-SUMMARY.md`
</output>
