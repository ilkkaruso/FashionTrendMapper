---
phase: 02-data-collection
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/fetchers/reddit-trends.ts
  - app/api/test/reddit-trends/route.ts
autonomous: true
user_setup:
  - service: reddit-api
    why: "Reddit API OAuth for fetching subreddit posts"
    env_vars:
      - name: REDDIT_CLIENT_ID
        source: "reddit.com/prefs/apps -> Create application -> client_id (under app name)"
      - name: REDDIT_CLIENT_SECRET
        source: "reddit.com/prefs/apps -> Create application -> secret"
      - name: REDDIT_REFRESH_TOKEN
        source: "OAuth flow - use https://not-an-aardvark.github.io/reddit-oauth-helper/ to generate"
      - name: REDDIT_USER_AGENT
        source: "Set to: FashionTrendMapper/1.0 by /u/YOUR_USERNAME"
    dashboard_config:
      - task: "Create Reddit script app"
        location: "reddit.com/prefs/apps -> Create another app -> script type"
      - task: "Generate refresh token via OAuth helper"
        location: "https://not-an-aardvark.github.io/reddit-oauth-helper/"

must_haves:
  truths:
    - "Reddit fetcher retrieves hot posts from fashion subreddits"
    - "Fetcher extracts fashion-relevant post data"
    - "Fetcher caches results to avoid rate limiting"
    - "Fetcher gracefully degrades when API fails"
  artifacts:
    - path: "lib/fetchers/reddit-trends.ts"
      provides: "Reddit fashion trends fetching"
      exports: ["fetchRedditTrends"]
    - path: "app/api/test/reddit-trends/route.ts"
      provides: "Manual test endpoint"
      exports: ["GET"]
  key_links:
    - from: "lib/fetchers/reddit-trends.ts"
      to: "snoowrap"
      via: "getSubreddit().getHot()"
      pattern: "getSubreddit.*getHot"
    - from: "lib/fetchers/reddit-trends.ts"
      to: "lib/utils/cache.ts"
      via: "getCached/setCache"
      pattern: "(getCached|setCache)"
---

<objective>
Create Reddit trends fetcher with OAuth authentication and caching.

Purpose: Fetch trending fashion posts from r/streetwear, r/malefashionadvice, r/femalefashionadvice as second data source.
Output: Working Reddit fetcher that returns RawTrend[] from hot posts across fashion subreddits.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-data-collection/02-RESEARCH.md
@lib/fetchers/types.ts (will exist from 02-01)
@lib/utils/cache.ts (will exist from 02-01)
@lib/utils/rate-limiter.ts (will exist from 02-01)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Reddit trends fetcher</name>
  <files>lib/fetchers/reddit-trends.ts</files>
  <action>
Create `lib/fetchers/reddit-trends.ts`:

Import snoowrap (CommonJS - may need `import Snoowrap from 'snoowrap'`).
Import types from `@/lib/fetchers/types`.
Import cache utilities from `@/lib/utils/cache`.
Import rate limiter from `@/lib/utils/rate-limiter`.

Define subreddits to fetch:
```typescript
const FASHION_SUBREDDITS = [
  'streetwear',          // 4.1M - streetwear trends
  'malefashionadvice',   // 5.2M - men's fashion
  'femalefashionadvice', // 3.2M - women's fashion
];
```

Create lazy-initialized snoowrap client (avoid initializing at import time):
```typescript
let redditClient: Snoowrap | null = null;

function getRedditClient(): Snoowrap {
  if (!redditClient) {
    redditClient = new Snoowrap({
      userAgent: process.env.REDDIT_USER_AGENT!,
      clientId: process.env.REDDIT_CLIENT_ID!,
      clientSecret: process.env.REDDIT_CLIENT_SECRET!,
      refreshToken: process.env.REDDIT_REFRESH_TOKEN!,
    });
    // Disable request queueing for serverless (we handle rate limits ourselves)
    redditClient.config({ requestDelay: 0 });
  }
  return redditClient;
}
```

Create `fetchRedditTrends(): Promise<FetchResult<RawTrend[]>>`:

1. Check rate limit (redditRatelimit, identifier: 'reddit-fashion')
2. Try cache first (key: 'reddit-trends-daily', TTL: 1 hour)
3. If cache hit, return with cached: true
4. If cache miss:
   - Get reddit client
   - Fetch hot posts from each subreddit in parallel using Promise.all
   - Use `.getHot({ time: 'day', limit: 25 })` for each subreddit
   - Handle rate limit errors (429) by returning stale cache
5. Map posts to RawTrend[]:
   ```typescript
   {
     title: post.title,
     score: post.ups, // Upvotes as raw score
     source: 'reddit' as SourceType,
     sourceUrl: `https://reddit.com${post.permalink}`,
     metadata: {
       subreddit: post.subreddit.display_name,
       comments: post.num_comments,
       created: new Date(post.created_utc * 1000).toISOString(),
       flair: post.link_flair_text || null
     }
   }
   ```
6. Filter posts:
   - Remove stickied posts (announcements)
   - Remove posts with < 10 upvotes (noise)
   - Keep posts from last 24 hours only
7. Cache result (1 hour fresh, 24 hour stale)
8. Return { success: true, data: trends }

Wrap in try-catch:
- Log errors with subreddit context
- Return stale cache if available
- Return { success: false, error } if no fallback

Handle snoowrap-specific errors:
- 401/403: Auth error - log and suggest checking credentials
- 429: Rate limit - use stale cache
- Network errors: Use stale cache
  </action>
  <verify>
`npx tsc --noEmit` passes.
Function signature: `fetchRedditTrends(): Promise<FetchResult<RawTrend[]>>`
  </verify>
  <done>
Reddit fetcher exports fetchRedditTrends function that:
- Uses snoowrap with OAuth
- Fetches from 3 fashion subreddits in parallel
- Filters for recent, non-stickied posts with 10+ upvotes
- Caches for 1 hour, falls back to 24hr stale cache
- Gracefully degrades on API errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Create test endpoint</name>
  <files>app/api/test/reddit-trends/route.ts</files>
  <action>
Create `app/api/test/reddit-trends/route.ts`:

```typescript
import { NextRequest } from 'next/server';
import { fetchRedditTrends } from '@/lib/fetchers/reddit-trends';

export const dynamic = 'force-dynamic';

export async function GET(request: NextRequest) {
  // Only allow in development or with secret
  const authHeader = request.headers.get('authorization');
  const isDev = process.env.NODE_ENV === 'development';
  const hasSecret = authHeader === `Bearer ${process.env.CRON_SECRET}`;

  if (!isDev && !hasSecret) {
    return Response.json({ error: 'Unauthorized' }, { status: 401 });
  }

  const result = await fetchRedditTrends();

  // Group by subreddit for debugging
  const bySubreddit = result.data?.reduce((acc, trend) => {
    const sub = (trend.metadata as any)?.subreddit || 'unknown';
    acc[sub] = (acc[sub] || 0) + 1;
    return acc;
  }, {} as Record<string, number>) || {};

  return Response.json({
    success: result.success,
    cached: result.cached || false,
    count: result.data?.length || 0,
    bySubreddit,
    data: result.data || [],
    error: result.error || null,
    timestamp: new Date().toISOString()
  });
}
```

This endpoint:
- Works in dev without auth
- Requires CRON_SECRET in production
- Shows post count per subreddit for debugging
  </action>
  <verify>
`npm run dev` starts without errors.
If Reddit credentials configured:
  `curl http://localhost:3000/api/test/reddit-trends` returns posts.
If credentials missing:
  Response shows auth error (expected until user sets up OAuth).
  </verify>
  <done>
Test endpoint created at /api/test/reddit-trends.
Shows success status, cached flag, count, breakdown by subreddit, and full data.
Returns helpful error if Reddit OAuth not configured.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npm run build`
2. Test endpoint responds: `curl http://localhost:3000/api/test/reddit-trends`
3. If OAuth configured, returns posts from 3 subreddits
4. If OAuth not configured, returns clear auth error
</verification>

<success_criteria>
- [ ] lib/fetchers/reddit-trends.ts exports fetchRedditTrends
- [ ] fetchRedditTrends returns FetchResult<RawTrend[]>
- [ ] Fetches from streetwear, malefashionadvice, femalefashionadvice
- [ ] Posts filtered: non-stickied, 10+ upvotes, last 24 hours
- [ ] Caching implemented (1hr fresh, 24hr stale fallback)
- [ ] Rate limiting checked before API calls
- [ ] Graceful degradation on API failure
- [ ] Test endpoint at /api/test/reddit-trends works
- [ ] TypeScript compilation passes
</success_criteria>

<output>
After completion, create `.planning/phases/02-data-collection/02-03-SUMMARY.md`
</output>
