---
phase: 02-data-collection
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - migrations/004_enable_write_policies.sql
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Trends can be upserted to database by title"
    - "Trend sources can be saved with upsert operations"
    - "Historical snapshots can be written to trend_history table"
    - "Service role has write access to all trend-related tables"
  artifacts:
    - path: "migrations/004_enable_write_policies.sql"
      provides: "RLS write policies and UNIQUE constraint"
      min_lines: 25
  key_links:
    - from: "migrations/004_enable_write_policies.sql"
      to: "trends table"
      via: "ALTER TABLE ADD CONSTRAINT"
      pattern: "ALTER TABLE trends ADD CONSTRAINT.*UNIQUE.*title"
    - from: "migrations/004_enable_write_policies.sql"
      to: "trends/trend_sources/trend_history tables"
      via: "CREATE POLICY for INSERT/UPDATE"
      pattern: "CREATE POLICY.*FOR (INSERT|UPDATE)"
---

<objective>
Fix database schema to allow writes to trends, trend_sources, and trend_history tables.

Purpose: Close verification gap preventing trend persistence - RLS currently blocks all writes, and trends.title lacks UNIQUE constraint needed for upsert operations.

Output: Migration 004 that adds write policies and UNIQUE constraint, enabling the cron job to save trends to database.
</objective>

<execution_context>
@/home/lesh/.claude/get-shit-done/workflows/execute-plan.md
@/home/lesh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/home/lesh/source/FashionTrendMapper/.planning/PROJECT.md
@/home/lesh/source/FashionTrendMapper/.planning/ROADMAP.md
@/home/lesh/source/FashionTrendMapper/.planning/STATE.md
@/home/lesh/source/FashionTrendMapper/.planning/phases/02-data-collection/02-VERIFICATION.md

# Existing migrations for reference
@/home/lesh/source/FashionTrendMapper/migrations/001_initial_schema.sql
@/home/lesh/source/FashionTrendMapper/migrations/002_trend_sources_junction.sql
@/home/lesh/source/FashionTrendMapper/migrations/003_add_current_score.sql

# Repository code that needs these fixes
@/home/lesh/source/FashionTrendMapper/lib/database/trend-repository.ts
</context>

<tasks>

<task type="auto">
  <name>Create migration 004 with write policies and UNIQUE constraint</name>
  <files>migrations/004_enable_write_policies.sql</files>
  <action>
Create migration file that fixes both blocking issues:

**1. Add UNIQUE constraint on trends.title:**
- Use `ALTER TABLE trends ADD CONSTRAINT trends_title_unique UNIQUE (title);`
- This enables the repository's `onConflict: 'title'` upsert to work
- Without this, Postgres throws "no unique or exclusion constraint matching ON CONFLICT" error

**2. Add INSERT policies for service_role:**
- trends table: `CREATE POLICY "Allow service role insert on trends" ON trends FOR INSERT TO service_role WITH CHECK (true);`
- trend_sources table: `CREATE POLICY "Allow service role insert on trend_sources" ON trend_sources FOR INSERT TO service_role WITH CHECK (true);`
- trend_history table: `CREATE POLICY "Allow service role insert on trend_history" ON trend_history FOR INSERT TO service_role WITH CHECK (true);`

**3. Add UPDATE policies for service_role:**
- trends table: `CREATE POLICY "Allow service role update on trends" ON trends FOR UPDATE TO service_role USING (true) WITH CHECK (true);`
- trend_sources table: `CREATE POLICY "Allow service role update on trend_sources" ON trend_sources FOR UPDATE TO service_role USING (true) WITH CHECK (true);`
- trend_history table: `CREATE POLICY "Allow service role update on trend_history" ON trend_history FOR UPDATE TO service_role USING (true) WITH CHECK (true);`

**Why service_role:** The cron job runs server-side with service_role credentials (not anon), so policies must target service_role. This is secure since service_role is never exposed to client.

**File structure:**
```sql
-- migrations/004_enable_write_policies.sql
-- Enable write operations for trends, trend_sources, and trend_history tables

-- Add UNIQUE constraint on trends.title for upsert support
ALTER TABLE trends ADD CONSTRAINT trends_title_unique UNIQUE (title);

-- INSERT policies (service_role only)
CREATE POLICY "Allow service role insert on trends"
  ON trends FOR INSERT
  TO service_role
  WITH CHECK (true);

CREATE POLICY "Allow service role insert on trend_sources"
  ON trend_sources FOR INSERT
  TO service_role
  WITH CHECK (true);

CREATE POLICY "Allow service role insert on trend_history"
  ON trend_history FOR INSERT
  TO service_role
  WITH CHECK (true);

-- UPDATE policies (service_role only)
CREATE POLICY "Allow service role update on trends"
  ON trends FOR UPDATE
  TO service_role
  USING (true)
  WITH CHECK (true);

CREATE POLICY "Allow service role update on trend_sources"
  ON trend_sources FOR UPDATE
  TO service_role
  USING (true)
  WITH CHECK (true);

CREATE POLICY "Allow service role update on trend_history"
  ON trend_history FOR UPDATE
  TO service_role
  USING (true)
  WITH CHECK (true);
```

**Note:** Migration is NOT fully idempotent - if run twice, constraint creation will fail. This is acceptable since Supabase migrations are version-tracked and typically run once.
  </action>
  <verify>
File exists and contains:
```bash
grep -q "ALTER TABLE trends ADD CONSTRAINT trends_title_unique UNIQUE (title)" /home/lesh/source/FashionTrendMapper/migrations/004_enable_write_policies.sql
grep -c "CREATE POLICY" /home/lesh/source/FashionTrendMapper/migrations/004_enable_write_policies.sql
# Should return 6 (3 INSERT + 3 UPDATE policies)
```
  </verify>
  <done>Migration file created with UNIQUE constraint and 6 RLS policies (INSERT + UPDATE for trends, trend_sources, trend_history)</done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <action>Apply migration 004 in Supabase SQL Editor</action>
  <instructions>
**What:** Execute the migration to fix database write permissions

**Where:** Supabase Dashboard → SQL Editor

**Steps:**
1. Navigate to https://supabase.com/dashboard/project/[your-project-id]/sql
2. Click "New Query"
3. Copy contents of `migrations/004_enable_write_policies.sql`
4. Paste into SQL Editor
5. Click "Run" button
6. Verify success message: "Success. No rows returned"

**Expected outcome:**
- UNIQUE constraint added to trends.title column
- 6 new RLS policies created (visible in Table Editor → trends/trend_sources/trend_history → Policies tab)
- No errors in execution

**Why manual:** Supabase migrations must be applied through their SQL Editor UI. There's no CLI command to apply migrations automatically in the free tier.

**Troubleshooting:**
- If "constraint already exists" error: Migration was already applied, safe to continue
- If "permission denied" error: Check you're using the correct Supabase project
- If RLS policy errors: Check policy names don't conflict with existing policies
  </instructions>
  <resume-signal>Type "applied" when migration is executed successfully</resume-signal>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Database schema fixes enabling trend persistence</what-built>
  <how-to-verify>
**Test 1: Verify UNIQUE constraint**
```bash
# Start dev server
npm run dev

# In another terminal, test the cron endpoint
curl -H "Authorization: Bearer $CRON_SECRET" http://localhost:3000/api/cron/fetch-trends
```

Expected response:
```json
{
  "success": true,
  "stats": {
    "trendsCount": 10-50,
    "savedCount": 10-50,
    "duration": "2-5s"
  },
  "timestamp": "2026-01-25T..."
}
```

**Key indicators of success:**
- `savedCount` matches `trendsCount` (no database errors)
- No "onConflict" errors in terminal logs
- No "row-level security policy" errors in terminal logs

**Test 2: Verify data in Supabase**
1. Go to Supabase Dashboard → Table Editor → trends
2. Verify rows exist with populated title, current_score, updated_at
3. Check trend_sources table has corresponding rows
4. Check trend_history table has daily snapshots

**Test 3: Verify change calculations work**
```bash
# Run cron twice (second run should calculate changes)
curl -H "Authorization: Bearer $CRON_SECRET" http://localhost:3000/api/cron/fetch-trends
sleep 2
curl -H "Authorization: Bearer $CRON_SECRET" http://localhost:3000/api/cron/fetch-trends
```

Second run should:
- Update existing trends (not create duplicates)
- Create new history snapshots for today
- Log "Saved N trends, 0 errors" in terminal

**What to check:**
- [ ] Cron endpoint returns success with savedCount > 0
- [ ] Trends table populated in Supabase
- [ ] No RLS or constraint errors in logs
- [ ] Second run updates existing trends (no duplicates by title)
  </how-to-verify>
  <resume-signal>Type "verified" when all checks pass, or describe issues if failures occur</resume-signal>
</task>

</tasks>

<verification>
**Schema verification:**
```sql
-- Run in Supabase SQL Editor to verify
SELECT constraint_name, constraint_type
FROM information_schema.table_constraints
WHERE table_name = 'trends' AND constraint_name = 'trends_title_unique';
-- Should return 1 row with constraint_type = 'UNIQUE'

SELECT policyname, cmd, roles
FROM pg_policies
WHERE tablename IN ('trends', 'trend_sources', 'trend_history')
  AND roles::text LIKE '%service_role%';
-- Should return 6 rows (INSERT + UPDATE for 3 tables)
```

**Functional verification:**
- Cron endpoint successfully saves trends to database
- No RLS policy violations in logs
- Upsert operations work correctly (no constraint errors)
- Historical snapshots created for change tracking
</verification>

<success_criteria>
1. Migration 004 file exists with UNIQUE constraint and 6 RLS policies
2. Migration applied successfully in Supabase (no errors)
3. UNIQUE constraint on trends.title verified in database
4. 6 RLS policies exist for service_role writes
5. Cron endpoint saves trends without errors
6. Trends, trend_sources, and trend_history tables populated
7. Gap from VERIFICATION.md closed - truth "Trends saved to database with source tracking" now passes
</success_criteria>

<output>
After completion, create `.planning/phases/02-data-collection/02-05-SUMMARY.md`
</output>
