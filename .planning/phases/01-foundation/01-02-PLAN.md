---
phase: 01-foundation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - migrations/001_initial_schema.sql
autonomous: false

user_setup:
  - service: supabase
    why: "PostgreSQL database for trend storage"
    account_setup:
      - step: "Create Supabase account at https://supabase.com"
      - step: "Create new project (name: fashion-trend-mapper, region: closest to you)"
      - step: "Wait for project provisioning (~2 minutes)"
    env_vars:
      - name: NEXT_PUBLIC_SUPABASE_URL
        source: "Supabase Dashboard → Settings → API → Project URL"
      - name: NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY
        source: "Supabase Dashboard → Settings → API → Project API keys → anon/public key"
    dashboard_config:
      - task: "Note database password from project creation (needed for direct SQL access if required)"
        location: "Supabase Dashboard → Settings → Database"

must_haves:
  truths:
    - "Database has trends table with required columns"
    - "Database has categories table for trend classification"
    - "Database has junction table for many-to-many trend-category relationships"
    - "Database has affiliate_products table linked to trends"
    - "Database has trend_history tables for daily and monthly data"
    - "Database has admin_config table for system settings"
    - "All tables have Row Level Security enabled"
    - "Public read access policies are configured"
  artifacts:
    - path: "migrations/001_initial_schema.sql"
      provides: "Complete database schema with all tables"
      contains: "CREATE TABLE trends"
      min_lines: 100
  key_links:
    - from: "trends"
      to: "categories"
      via: "trend_categories junction table"
      pattern: "trend_categories.*REFERENCES trends.*REFERENCES categories"
    - from: "affiliate_products"
      to: "trends"
      via: "foreign key"
      pattern: "REFERENCES trends\\(id\\)"
    - from: "trend_history"
      to: "trends"
      via: "foreign key"
      pattern: "REFERENCES trends\\(id\\)"
---

<objective>
Create and configure Supabase project with complete PostgreSQL database schema for fashion trend tracking. Establish all required tables with proper relationships, indexes, and Row Level Security policies.

Purpose: Provide the data persistence layer that will store trends, categories, affiliate products, and historical data for the application.

Output: Supabase project with provisioned database containing 8 tables (trends, categories, trend_categories, trend_sources, affiliate_products, trend_history, trend_history_monthly, admin_config) and environment variables ready for Next.js integration.
</objective>

<execution_context>
@/home/lesh/.claude/get-shit-done/workflows/execute-plan.md
@/home/lesh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/home/lesh/source/FashionTrendMapper/.planning/PROJECT.md
@/home/lesh/source/FashionTrendMapper/.planning/ROADMAP.md
@/home/lesh/source/FashionTrendMapper/.planning/STATE.md
@/home/lesh/source/FashionTrendMapper/.planning/phases/01-foundation/01-RESEARCH.md
@/home/lesh/source/FashionTrendMapper/.planning/phases/01-foundation/01-CONTEXT.md
</context>

<tasks>

<task type="checkpoint:human-action" gate="blocking">
  <action>Create Supabase project</action>
  <instructions>
    1. Visit https://supabase.com and sign up/login
    2. Click "New Project"
    3. Fill in project details:
       - Name: fashion-trend-mapper
       - Database Password: Generate strong password (save this!)
       - Region: Choose closest to your location (e.g., us-east-1)
       - Pricing Plan: Free
    4. Click "Create new project"
    5. Wait for provisioning to complete (~2 minutes)
    6. Once ready, navigate to Settings → API
    7. Copy the following values:
       - Project URL (format: https://xxxxx.supabase.co)
       - API Key - anon/public (format: eyJhbG...)
    8. Create `.env.local` file in project root (if not exists) and add:
       ```
       NEXT_PUBLIC_SUPABASE_URL=https://xxxxx.supabase.co
       NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY=eyJhbG...
       ```
    9. Add `.env*.local` to .gitignore if not already present
  </instructions>
  <resume-signal>Reply with "supabase-created" when project is provisioned and .env.local is configured</resume-signal>
</task>

<task type="auto">
  <name>Task 1: Create database migration with complete schema</name>
  <files>
    migrations/001_initial_schema.sql
  </files>
  <action>
    Create migrations/001_initial_schema.sql file with the complete schema from RESEARCH.md (lines 537-649). This includes:

    **Enable extensions:**
    - uuid-ossp for UUID generation

    **Create 8 tables:**
    1. trends (id, title, description, image_url, thumbnail_url, external_links JSONB, timestamps)
    2. categories (id, name UNIQUE, slug UNIQUE, timestamp)
    3. trend_categories (trend_id, category_id, composite PK, foreign keys with CASCADE)
    4. trend_sources (id, name UNIQUE, url, timestamp)
    5. affiliate_products (id, trend_id FK, product_name, affiliate_link, price_range, timestamp)
    6. trend_history (id, trend_id FK, snapshot_date, view_count, click_count, data_snapshot JSONB, UNIQUE constraint on trend_id + snapshot_date)
    7. trend_history_monthly (id, trend_id FK, year, month, total_views, total_clicks, UNIQUE constraint on trend_id + year + month)
    8. admin_config (id, key UNIQUE, value JSONB, timestamps)

    **Create indexes:**
    - idx_trends_created_at on trends(created_at DESC)
    - idx_trend_categories_trend on trend_categories(trend_id)
    - idx_trend_categories_category on trend_categories(category_id)
    - idx_affiliate_products_trend on affiliate_products(trend_id)
    - idx_trend_history_trend_date on trend_history(trend_id, snapshot_date DESC)
    - idx_trend_history_monthly_trend on trend_history_monthly(trend_id, year DESC, month DESC)

    **Enable RLS and create policies:**
    - Enable Row Level Security on all tables
    - Create "Allow public read" policies for: trends, categories, trend_categories, affiliate_products (for SELECT operations)
    - No write policies yet (added in Phase 5 with admin auth)

    Use EXACTLY the schema from RESEARCH.md lines 537-649. Do not modify column types or constraints. Use gen_random_uuid() for UUID defaults, not uuid_generate_v4() (gen_random_uuid is built-in to modern Postgres, no extension needed - remove uuid-ossp if it causes issues).
  </action>
  <verify>
    - File migrations/001_initial_schema.sql exists
    - File contains CREATE TABLE statements for all 8 tables
    - File contains CREATE INDEX statements for all 6 indexes
    - File contains ALTER TABLE and CREATE POLICY statements for RLS
    - SQL is valid PostgreSQL syntax (no syntax errors)
  </verify>
  <done>
    Migration file created with complete schema including all tables, indexes, and RLS policies. Ready to be executed in Supabase.
  </done>
</task>

<task type="auto">
  <name>Task 2: Run migration in Supabase SQL editor</name>
  <files>migrations/001_initial_schema.sql</files>
  <action>
    Execute the migration file in Supabase:

    1. Read the contents of migrations/001_initial_schema.sql
    2. Open Supabase Dashboard → SQL Editor
    3. Create new query, paste the entire migration SQL
    4. Click "Run" to execute
    5. Verify success (should see "Success. No rows returned" or similar)
    6. Navigate to Table Editor to confirm all 8 tables exist:
       - trends
       - categories
       - trend_categories
       - trend_sources
       - affiliate_products
       - trend_history
       - trend_history_monthly
       - admin_config

    If migration fails, check error message:
    - UUID extension errors: Remove CREATE EXTENSION line (gen_random_uuid is built-in)
    - Syntax errors: Fix SQL and re-run
    - Permission errors: Ensure using project owner credentials

    After successful migration, optionally seed categories table with initial values (Claude's discretion):
    ```sql
    INSERT INTO categories (name, slug) VALUES
      ('Clothing', 'clothing'),
      ('Styles & Aesthetics', 'styles-aesthetics'),
      ('Brands', 'brands'),
      ('Colors & Patterns', 'colors-patterns')
    ON CONFLICT (slug) DO NOTHING;
    ```
  </action>
  <verify>
    - Visit Supabase Dashboard → Table Editor
    - Confirm all 8 tables visible in left sidebar
    - Click each table and verify columns match schema
    - Check trends table has: id (uuid), title (text), description (text), image_url (text), thumbnail_url (text), external_links (jsonb), created_at, updated_at
    - Check trend_categories has composite primary key on (trend_id, category_id)
  </verify>
  <done>
    All 8 tables created successfully in Supabase database with correct columns, foreign keys, indexes, and RLS policies. Categories optionally seeded with initial values. Schema matches RESEARCH.md specification exactly.
  </done>
</task>

</tasks>

<verification>
1. Supabase project exists and is accessible at dashboard URL
2. .env.local file contains NEXT_PUBLIC_SUPABASE_URL and NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY
3. migrations/001_initial_schema.sql file exists with complete schema
4. All 8 tables exist in Supabase database (visible in Table Editor)
5. Foreign key relationships are correctly configured (check Table Editor → Relationships tab)
6. Indexes are created (check Table Editor → Table → Indexes tab)
7. Row Level Security is enabled on all tables
8. Public read policies exist for trends, categories, trend_categories, affiliate_products
</verification>

<success_criteria>
- Supabase project created and accessible ✓
- Environment variables configured in .env.local ✓
- Database migration file created with all required tables ✓
- Migration executed successfully in Supabase ✓
- All 8 tables exist with correct schema ✓
- Foreign key relationships established ✓
- Indexes created for performance ✓
- Row Level Security enabled with public read policies ✓
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-02-SUMMARY.md` following the summary template.
</output>
