---
phase: 01-foundation
plan: 03
type: execute
wave: 2
depends_on: [01-01, 01-02]
files_modified:
  - lib/supabase/client.ts
  - lib/supabase/server.ts
  - middleware.ts
  - package.json
  - vercel.json
autonomous: false

user_setup:
  - service: vercel
    why: "Deployment platform for Next.js application"
    account_setup:
      - step: "Create Vercel account at https://vercel.com (can use GitHub login)"
    env_vars:
      - name: NEXT_PUBLIC_SUPABASE_URL
        source: "Same value from .env.local"
      - name: NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY
        source: "Same value from .env.local"
    dashboard_config:
      - task: "Import Git repository and configure environment variables"
        location: "Vercel Dashboard → Add New Project → Import Git Repository"

must_haves:
  truths:
    - "Supabase client can be instantiated in Client Components"
    - "Supabase client can be instantiated in Server Components"
    - "Middleware refreshes auth tokens on every request"
    - "App deploys successfully to Vercel"
    - "Deployed app can connect to Supabase database"
    - "Environment variables are configured in Vercel"
  artifacts:
    - path: "lib/supabase/client.ts"
      provides: "Browser Supabase client for Client Components"
      exports: ["createClient"]
      min_lines: 8
    - path: "lib/supabase/server.ts"
      provides: "Server Supabase client for Server Components"
      exports: ["createClient"]
      min_lines: 20
    - path: "middleware.ts"
      provides: "Auth token refresh middleware"
      exports: ["middleware", "config"]
      min_lines: 25
  key_links:
    - from: "lib/supabase/client.ts"
      to: "@supabase/ssr"
      via: "createBrowserClient import"
      pattern: "import.*createBrowserClient.*@supabase/ssr"
    - from: "lib/supabase/server.ts"
      to: "@supabase/ssr"
      via: "createServerClient import"
      pattern: "import.*createServerClient.*@supabase/ssr"
    - from: "middleware.ts"
      to: "lib/supabase/server.ts"
      via: "uses createServerClient pattern"
      pattern: "createServerClient"
    - from: "Server Components"
      to: "lib/supabase/server.ts"
      via: "import for database queries"
      pattern: "import.*createClient.*@/lib/supabase/server"
---

<objective>
Integrate Supabase with Next.js using proper SSR patterns and deploy the application to Vercel with environment variable configuration. Establish the connection between frontend and database, and make the application publicly accessible.

Purpose: Complete the infrastructure stack by wiring together Next.js (frontend), Supabase (database), and Vercel (hosting) with proper authentication handling for future features.

Output: Deployed application on Vercel with working Supabase connection, ready to fetch and display trend data in future phases.
</objective>

<execution_context>
@/home/lesh/.claude/get-shit-done/workflows/execute-plan.md
@/home/lesh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/home/lesh/source/FashionTrendMapper/.planning/PROJECT.md
@/home/lesh/source/FashionTrendMapper/.planning/ROADMAP.md
@/home/lesh/source/FashionTrendMapper/.planning/STATE.md
@/home/lesh/source/FashionTrendMapper/.planning/phases/01-foundation/01-RESEARCH.md
@/home/lesh/source/FashionTrendMapper/.planning/phases/01-foundation/01-CONTEXT.md

# Reference prior plan outputs
@/home/lesh/source/FashionTrendMapper/.planning/phases/01-foundation/01-01-SUMMARY.md
@/home/lesh/source/FashionTrendMapper/.planning/phases/01-foundation/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Supabase SSR package and create client utilities</name>
  <files>
    package.json
    lib/supabase/client.ts
    lib/supabase/server.ts
    middleware.ts
  </files>
  <action>
    Install Supabase dependencies:
    ```bash
    npm install @supabase/supabase-js @supabase/ssr
    ```

    Create lib/supabase/client.ts for Client Components (browser context):
    ```typescript
    import { createBrowserClient } from '@supabase/ssr'

    export function createClient() {
      return createBrowserClient(
        process.env.NEXT_PUBLIC_SUPABASE_URL!,
        process.env.NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY!
      )
    }
    ```

    Create lib/supabase/server.ts for Server Components (server context):
    ```typescript
    import { createServerClient } from '@supabase/ssr'
    import { cookies } from 'next/headers'

    export async function createClient() {
      const cookieStore = await cookies()

      return createServerClient(
        process.env.NEXT_PUBLIC_SUPABASE_URL!,
        process.env.NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY!,
        {
          cookies: {
            getAll() {
              return cookieStore.getAll()
            },
            setAll(cookiesToSet) {
              try {
                cookiesToSet.forEach(({ name, value, options }) =>
                  cookieStore.set(name, value, options)
                )
              } catch {
                // Server Component - can't write cookies
                // Middleware handles token refresh
              }
            },
          },
        }
      )
    }
    ```

    Create middleware.ts at project root for auth token refresh:
    ```typescript
    import { createServerClient } from '@supabase/ssr'
    import { NextResponse, type NextRequest } from 'next/server'

    export async function middleware(request: NextRequest) {
      let response = NextResponse.next({ request })

      const supabase = createServerClient(
        process.env.NEXT_PUBLIC_SUPABASE_URL!,
        process.env.NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY!,
        {
          cookies: {
            getAll() {
              return request.cookies.getAll()
            },
            setAll(cookiesToSet) {
              cookiesToSet.forEach(({ name, value, options }) => {
                request.cookies.set(name, value)
                response.cookies.set(name, value, options)
              })
            },
          },
        }
      )

      // Refresh session if expired
      await supabase.auth.getUser()

      return response
    }

    export const config = {
      matcher: [
        '/((?!_next/static|_next/image|favicon.ico|.*\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)',
      ],
    }
    ```

    Use EXACTLY the patterns from RESEARCH.md (lines 96-177). Do not modify the cookie handling logic - it's designed to handle Server Component constraints.
  </action>
  <verify>
    - Run `npm install` completes successfully
    - Files lib/supabase/client.ts and lib/supabase/server.ts exist
    - File middleware.ts exists at project root
    - TypeScript compilation succeeds (`npm run build` or check in editor)
    - No import errors for @supabase/ssr or @supabase/supabase-js
  </verify>
  <done>
    Supabase SSR package installed. Three files created: lib/supabase/client.ts (browser client), lib/supabase/server.ts (server client with cookie handling), middleware.ts (auth token refresh). All files follow RESEARCH.md patterns exactly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add database connection test to home page</name>
  <files>
    app/page.tsx
  </files>
  <action>
    Update app/page.tsx to test database connection by fetching category count from Supabase:

    ```typescript
    import { createClient } from '@/lib/supabase/server'

    export default async function HomePage() {
      const supabase = await createClient()

      // Test database connection
      const { data: categories, error } = await supabase
        .from('categories')
        .select('*')

      return (
        <main className="container mx-auto px-4 py-8">
          <h1 className="text-3xl font-bold mb-4">Fashion Trends</h1>
          <p className="text-gray-600 mb-4">Trend visualization coming soon...</p>

          {/* Database connection test */}
          <div className="mt-8 p-4 border rounded-lg bg-gray-50">
            <h2 className="text-sm font-semibold text-gray-700 mb-2">Database Status</h2>
            {error ? (
              <p className="text-sm text-red-600">Error: {error.message}</p>
            ) : (
              <p className="text-sm text-green-600">
                ✓ Connected to Supabase ({categories?.length || 0} categories)
              </p>
            )}
          </div>
        </main>
      )
    }
    ```

    This provides visual confirmation that:
    - Server Component can import and use server Supabase client
    - Database connection works
    - Environment variables are configured correctly
    - Categories table is accessible (seeded in Plan 02)

    The test display can be removed in Phase 2 when real trend data is added.
  </action>
  <verify>
    - Run `npm run dev`
    - Visit http://localhost:3000
    - See "Database Status" section showing either:
      - "✓ Connected to Supabase (N categories)" if .env.local is configured correctly
      - Error message if connection fails (check NEXT_PUBLIC_SUPABASE_URL and NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY)
    - No console errors related to Supabase
  </verify>
  <done>
    Home page updated to test database connection. Page fetches categories from Supabase and displays connection status. Server Component successfully uses server Supabase client with cookie-based auth handling.
  </done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <action>Deploy to Vercel and configure environment variables</action>
  <instructions>
    1. Ensure code is committed to Git repository (GitHub, GitLab, or Bitbucket)
    2. Visit https://vercel.com and sign up/login (GitHub login recommended)
    3. Click "Add New Project"
    4. Import your Git repository:
       - Select repository provider (GitHub/GitLab/Bitbucket)
       - Authorize Vercel to access repositories
       - Select FashionTrendMapper repository
    5. Configure project:
       - Framework Preset: Next.js (should auto-detect)
       - Root Directory: ./ (leave default)
       - Build Command: (leave default - next build)
       - Output Directory: (leave default - .next)
    6. Add Environment Variables:
       - Click "Environment Variables" section
       - Add NEXT_PUBLIC_SUPABASE_URL = (copy from .env.local)
       - Add NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY = (copy from .env.local)
       - Apply to: Production, Preview, Development (all three)
    7. Click "Deploy"
    8. Wait for deployment to complete (~2-3 minutes)
    9. Once complete, click "Visit" to open deployed app
    10. Copy deployment URL (format: https://fashion-trend-mapper-xxxxx.vercel.app)
  </instructions>
  <resume-signal>Reply with deployment URL when app is live (e.g., "https://fashion-trend-mapper-xxxxx.vercel.app")</resume-signal>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete Next.js application deployed to Vercel with Supabase database integration. Application includes:
    - Three routes (/, /archive, /admin) with header navigation and footer
    - Supabase client utilities for server and browser contexts
    - Middleware for auth token refresh
    - Database connection test on home page
    - Environment variables configured for Production, Preview, and Development
  </what-built>
  <how-to-verify>
    1. Visit deployment URL from previous step (https://fashion-trend-mapper-xxxxx.vercel.app)
    2. Verify home page loads with:
       - ✓ "Fashion Trends" heading
       - ✓ Header navigation (Home | Archive | Admin)
       - ✓ Footer with affiliate disclosure
       - ✓ "Database Status" showing "✓ Connected to Supabase (N categories)"
    3. Click "Archive" navigation link:
       - ✓ Navigate to /archive
       - ✓ See "Trend Archive" heading
       - ✓ Header and footer still visible
    4. Click "Admin" navigation link:
       - ✓ Navigate to /admin
       - ✓ See "Admin Dashboard" heading
       - ✓ Header and footer still visible
    5. Click "Home" navigation link:
       - ✓ Return to /
       - ✓ Database status still shows connected
    6. Check Vercel Dashboard:
       - ✓ Deployment status shows "Ready"
       - ✓ Build logs show no errors
       - ✓ Environment variables are set (Settings → Environment Variables)

    Expected: All pages load successfully, navigation works, database connection confirmed, no errors in browser console.
  </how-to-verify>
  <resume-signal>Type "verified" if all checks pass, or describe any issues encountered</resume-signal>
</task>

</tasks>

<verification>
1. Package.json includes @supabase/supabase-js and @supabase/ssr
2. Files lib/supabase/client.ts and lib/supabase/server.ts exist with correct patterns
3. File middleware.ts exists with auth refresh logic
4. Home page successfully queries Supabase categories table
5. Local development (`npm run dev`) shows database connection working
6. App deploys successfully to Vercel
7. Deployed app shows database connection status (not error)
8. All three routes (/, /archive, /admin) are accessible on deployed app
9. Environment variables configured in Vercel for all environments
10. No TypeScript or build errors
</verification>

<success_criteria>
- Supabase client utilities created following SSR best practices ✓
- Middleware handles auth token refresh across all routes ✓
- Server Components can query Supabase database ✓
- Home page displays database connection test successfully ✓
- App deploys to Vercel without errors ✓
- Environment variables configured in Vercel ✓
- Deployed app connects to Supabase database ✓
- All routes accessible and functional on production deployment ✓
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-03-SUMMARY.md` following the summary template.
</output>
